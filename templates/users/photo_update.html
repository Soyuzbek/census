{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %}
{% load replace_asterisk %}
{% load users_extras %}

{% block head %}
    <style>
        .image-container {
            width: 500px;
            height: 500px;
        }

        img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="d-flex">
        <div class="image-container mx-auto">
            <img src="{% static 'img/nophoto.png' %}" alt="" id="image">
        </div>
    </div>
    <div class="d-flex">
        <form class="mx-auto" method="post">
            {% csrf_token %}
            <input type="file" name="image" id="img" title=" "/>
        </form>
        <div>
            <button class="btn btn-primary" id="save-btn">Save</button>
        </div>
    </div>

{% endblock %}

{% block js %}
    <script>
        $(document).ready(function () {
            $("input[id='img']").change(function () {
                let image = document.getElementById('image');
                let files = $(this)[0].files;
                let file = files[0];
                $('#image').attr('src', window.URL.createObjectURL(file));
                let cropper = new Cropper(image, {
                    aspectRatio: 2 / 3
                });

                cropper.crop();

                $('#save-btn').click(function () {
                    cropper.getCroppedCanvas().toBlob(function (blob) {
                        let form = new FormData();
                        form.append("image", blob);
                        alert(getCookie('csrftoken'));
                        form.append('csrfmiddlewaretoken', getCookie('csrftoken'));
                        $.ajax({
                            type: 'POST',
                            url: "{% url 'users:update_photo' object.pk %}",
                            data: form,
                            processData: false,
                            contentType: false,
                            success: function (data) {

                            },
                            error: function (err) {

                            }
                        })
                    });
                });
            });
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                let cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
{% endblock %}