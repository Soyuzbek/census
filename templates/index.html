{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %}
{% block title %}
    {% trans 'Home' %}
{% endblock %}
{% block content %}
    <section>
        <div class="container">
            <div class="loading">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
            <h5 class="mt-5 text-center">{% trans 'Employee Creation Form' %}</h5>
            <form action="{% url 'users:home' %}" method="post" enctype="multipart/form-data" data-ajax="false">
                {% csrf_token %}
                <div class="row">
                    <div class="form-group col-md-7 col-sm-12 mx-auto">
                        <label for="id_{{ form.serial.label|lower }}"
                               class="col-form-label">{{ form.serial.label }}</label>
                        {{ form.serial }}
                        {{ form.serial.help }}
                        {% if form.serial.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.serial.errors %}
                                    <small>
                                        {{ error|striptags }}
                                    </small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group col-md-7 col-sm-12 mx-auto">
                        <label for="id_{{ form.passport_num.label|lower }}"
                               class="col-form-label">{{ form.passport_num.label }}</label>
                        {{ form.passport_num }}
                        {{ form.passport_num.help }}
                        {% if form.passport_num.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.passport_num.errors %}
                                    <small>
                                        {{ error|striptags }}
                                    </small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group col-md-7 col-sm-12 mx-auto">
                        <label for="id_{{ form.PIN.label|lower }}" class="col-form-label">{{ form.PIN.label }}</label>
                        {{ form.PIN }}
                        {{ form.PIN.help }}
                        {% if form.PIN.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.PIN.errors %}
                                    <small>
                                        {{ error|striptags }}
                                    </small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    {% for field in form.visible_fields %}
                        {% if not field.name == 'serial' and not field.name == 'passport_num' and not field.name == 'PIN' %}
                            <div class="form-group col-md-7 col-sm-12 mx-auto disabled-wrap-box">
                                <label for="id_{{ field.label|lower }}" class="col-form-label">{{ field.label }}</label>
                                {{ field }}
                                {{ field.help }}
                                {% if field.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in field.errors %}
                                            <small>
                                                {{ error|striptags }}
                                            </small><br>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                    {% for field in form.hidden_fields %}
                        <div style="display:none;">{{ field }}</div>
                        {% if field.errors %}
                            {% for error in errors %}
                                <small class="alert text-danger">{{ error|striptags }}</small>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </div>

                <div class="row">
                    <div class="col-md-7 col-sm-12 mx-auto mt-5">
                        <button type="submit" class="btn-full btn-add">{% trans 'Add' %}</button>
                    </div>
                </div>
            </form>
        </div>
    </section>

{% endblock %}
{% block js %}
    <script>
        $(document).ready(function () {
            $('.masked').mask('000000000');
            $('.date').mask('00.00.0000');
            $('.disabled-wrap-box input').attr('disabled', 'disabled');
            $('.disabled-wrap-box select').attr('disabled', 'disabled');

            let role = $('#id_role option:selected').val();

            if (role == 'cor') {
                $('#id_department').parents('.form-group').css({
                    "display": "block"
                });
                $('#id_sector').parents('.form-group').css({
                    "display": "none"
                });
                $('#id_plot').parents('.form-group').css({
                    "display": "none"
                });
            } else if (role == 'ins') {
                $('#id_department').parents('.form-group').css({
                    "display": "block"
                });
                $('#id_sector').parents('.form-group').css({
                    "display": "block"
                });
                $('#id_plot').parents('.form-group').css({
                    "display": "none"
                });
            } else if (role == 'enum') {
                $('#id_department').parents('.form-group').css({
                    "display": "block"
                });
                $('#id_sector').parents('.form-group').css({
                    "display": "block"
                });
                $('#id_plot').parents('.form-group').css({
                    "display": "block"
                });
            }

            $('#id_role').change(function () {
                let role = $("#id_role option:selected").val();
                if (role == 'cor') {
                    $('#id_department').parents('.form-group').css({
                        "display": "block"
                    });
                    $('#id_sector').parents('.form-group').css({
                        "display": "none"
                    });
                    $('#id_plot').parents('.form-group').css({
                        "display": "none"
                    });
                } else if (role == 'ins') {
                    $('#id_department').parents('.form-group').css({
                        "display": "block"
                    });
                    $('#id_sector').parents('.form-group').css({
                        "display": "block"
                    });
                    $('#id_plot').parents('.form-group').css({
                        "display": "none"
                    });
                } else if (role == 'enum') {
                    $('#id_department').parents('.form-group').css({
                        "display": "block"
                    });
                    $('#id_sector').parents('.form-group').css({
                        "display": "block"
                    });
                    $('#id_plot').parents('.form-group').css({
                        "display": "block"
                    });
                }
            });

            $('#id_PIN').keypress(function (e) {
                if (e.which == 13) {
                    $('.disabled-wrap-box input').removeAttr('disabled');
                    $('.disabled-wrap-box select').removeAttr('disabled');
                    let pin = $(this).val();
                    let serial = $('#id_serial').val();
                    let passport_num = $('#id_passport_num').val();
                    let name = document.getElementById('id_first_name');
                    let surname = document.getElementById('id_last_name');
                    let patronymic = document.getElementById('id_patronymic');
                    let gender = document.getElementById('id_gender');
                    let date_of_birth = document.getElementById('id_birth_day');
                    let address = document.getElementById('id_address');
                    $.ajax({
                        url: "{% url 'users:load_data_by_pin' %}",
                        data: {
                            'pin': pin,
                            'serial': serial,
                            'passport_num': passport_num
                        },
                        dataType: 'json',
                        success: function (data) {
                            console.log(data);
                            if (data.is_exist) {
                                name.value = data.name;
                                surname.value = data.surname;
                                patronymic.value = data.patronymic;
                                gender.value = data.gender;
                                date_of_birth.value = data.dateOfBirth;
                                address.value = data.address;
                            } else {
                                alert(data.error_text);
                            }
                        }
                    });
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
{% endblock js %}
